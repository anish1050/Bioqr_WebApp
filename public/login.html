<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | BioQR</title>
  <!-- Security headers to prevent caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="login.css" rel="stylesheet">
</head>
<body>
  <!-- Animated Background -->
  <div class="background-animation">
    <div class="floating-shapes">
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
      <div class="shape shape-3"></div>
      <div class="shape shape-4"></div>
      <div class="shape shape-5"></div>
    </div>
  </div>

  <!-- Main Login Container -->
  <div class="login-container">
    <!-- Brand Header -->
    <div class="brand-header">
      <div class="logo-container">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
        </div>
        <h1 class="brand-name">BioQR</h1>
      </div>
      <p class="brand-tagline">Secure QR Code File Sharing</p>
    </div>

    <!-- Login Section -->
    <div class="login-section">
      <div class="login-card">
        <div class="card-header">
          <h2>Welcome Back</h2>
          <p>Sign in to your account to continue</p>
        </div>

        <form class="login-form" onsubmit="loginUser(event)">
          <div class="form-group">
            <label for="loginField">Username or Email</label>
            <div class="input-wrapper" id="loginField-wrapper">
              <svg class="input-icon" id="login-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <input
                id="loginField"
                type="text"
                placeholder="Enter username or email"
                required
                autocomplete="username"
                onfocus="handleInputFocus('loginField-wrapper')"
                onblur="handleInputBlur('loginField-wrapper')"
                oninput="updateLoginIcon()"
              >
            </div>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <div class="input-wrapper" id="password-wrapper">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <circle cx="12" cy="16" r="1"></circle>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <input
                id="password"
                type="password"
                placeholder="Enter your password"
                required
                autocomplete="current-password"
                onfocus="handleInputFocus('password-wrapper')"
                onblur="handleInputBlur('password-wrapper')"
              >
              <button type="button" class="password-toggle" id="password-toggle" onclick="togglePassword()">
                <svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>

          <div class="form-options">
            <label class="checkbox-container">
              <input type="checkbox" id="remember-me">
              <span class="checkmark"></span>
              Remember me
            </label>
            <a href="#" class="forgot-password">Forgot password?</a>
          </div>

          <button type="submit" class="login-btn" id="login-btn">
            <span class="btn-text">Sign In</span>
            <div class="btn-loading" id="btn-loading">
              <div class="spinner"></div>
              <span>Signing in...</span>
            </div>
          </button>
        </form>

        <div class="divider">
          <span>or continue with</span>
        </div>

        <div class="social-login">
          <button type="button" class="social-btn" onclick="loginWithGoogle()" id="google-login-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            Continue with Google
          </button>
          <button type="button" class="social-btn" onclick="loginWithGitHub()" id="github-login-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            Continue with GitHub
          </button>
        </div>

        <div class="signup-link">
          Don't have an account? <a href="register.html">Sign up</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Container for notifications -->
  <div id="message-container" class="message-container" style="display: none;">
    <div class="message-content">
      <svg class="message-icon success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20,6 9,17 4,12"></polyline>
      </svg>
      <svg class="message-icon error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <svg class="message-icon info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="m9,9h6"></path>
        <path d="m9,13h6"></path>
      </svg>
      <span class="message-text" id="message-text"></span>
    </div>
  </div>

  <script>
    // Global variables
    const API_BASE = 'http://localhost:3000';
    let isLoading = false;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already logged in
      const accessToken = localStorage.getItem('accessToken');
      if (accessToken) {
        window.location.href = '/dashboard.html';
        return;
      }

      // Handle URL parameters (OAuth errors)
      handleUrlParameters();

      // Initialize form enhancements
      initializeFormEnhancements();
    });
    
    // Handle URL parameters for OAuth responses
    function handleUrlParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      
      const message = urlParams.get('message');
      const provider = urlParams.get('provider');
      
      if (error) {
        let errorMessage = 'Authentication failed';
        
        switch (error) {
          case 'oauth_failed':
            errorMessage = 'Social login failed. Please try again.';
            break;
          case 'session_failed':
            errorMessage = 'Session creation failed. Please try again.';
            break;
          default:
            errorMessage = 'Authentication error occurred.';
        }
        
        showMessage(errorMessage, 'error');
      } else if (message) {
        let messageText = '';
        let messageType = 'info';
        
        switch (message) {
          case 'registration_success':
            messageText = `Account created successfully with ${provider === 'google' ? 'Google' : 'GitHub'}! You can now sign in.`;
            messageType = 'success';
            break;
          case 'user_exists':
            messageText = `You already have an account with ${provider === 'google' ? 'Google' : 'GitHub'}. Please sign in instead.`;
            messageType = 'info';
            break;
          default:
            messageText = 'Please sign in to continue.';
        }
        
        showMessage(messageText, messageType);
      }
      
      if (error || message) {
        // Clean URL
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    }

    // Enhanced login function
    async function loginUser(event) {
      event.preventDefault();

      if (isLoading) return;

      const loginField = document.getElementById('loginField').value.trim();
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('login-btn');
      const btnText = loginBtn.querySelector('.btn-text');
      const btnLoading = loginBtn.querySelector('.btn-loading');

      // Validation
      if (!loginField || !password) {
        showMessage('Please fill in all fields', 'error');
        return;
      }

      // Additional validation for email format if user entered email
      if (loginField.includes('@')) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(loginField)) {
          showMessage('Please enter a valid email address', 'error');
          return;
        }
      }

      // Start loading state
      setLoadingState(true);

      try {
        const response = await fetch(`${API_BASE}/bioqr/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ loginField, password })
        });

        const data = await response.json();

        if (data.success) {
          // Clear any logout flag
          localStorage.removeItem('userLoggedOut');
          
          // Store authentication tokens and user data
          localStorage.setItem('accessToken', data.tokens.accessToken);
          localStorage.setItem('refreshToken', data.tokens.refreshToken);
          localStorage.setItem('username', data.user.username);
          localStorage.setItem('userInfo', JSON.stringify(data.user));
          
          showMessage('Login successful! Redirecting...', 'success');
          
          // Redirect after a short delay using replace to prevent back navigation
          setTimeout(() => {
            window.location.replace('/dashboard.html');
          }, 1000);
        } else {
          showMessage(data.message || 'Login failed', 'error');
          setLoadingState(false);
        }
      } catch (err) {
        console.error('Login error:', err);
        showMessage('Network error. Please try again.', 'error');
        setLoadingState(false);
      }
    }

    // Set loading state
    function setLoadingState(loading) {
      isLoading = loading;
      const loginBtn = document.getElementById('login-btn');
      const btnText = loginBtn.querySelector('.btn-text');
      const btnLoading = loginBtn.querySelector('.btn-loading');
      
      if (loading) {
        loginBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'flex';
      } else {
        loginBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    }

    // Show message function
    function showMessage(text, type) {
      const messageContainer = document.getElementById('message-container');
      const messageText = document.getElementById('message-text');
      
      messageText.textContent = text;
      messageContainer.className = `message-container ${type}`;
      messageContainer.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        messageContainer.style.display = 'none';
      }, 5000);
    }

    // Input focus handlers
    function handleInputFocus(wrapperId) {
      const wrapper = document.getElementById(wrapperId);
      wrapper.classList.add('focused');
    }

    function handleInputBlur(wrapperId) {
      const wrapper = document.getElementById(wrapperId);
      const input = wrapper.querySelector('input');
      if (!input.value) {
        wrapper.classList.remove('focused');
      }
    }

    // Password toggle function
    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const passwordToggle = document.getElementById('password-toggle');
      const eyeOpen = passwordToggle.querySelector('.eye-open');
      const eyeClosed = passwordToggle.querySelector('.eye-closed');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
        passwordToggle.classList.add('active');
      } else {
        passwordInput.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
        passwordToggle.classList.remove('active');
      }
    }

    // OAuth login functions
    function loginWithGoogle() {
      const googleBtn = document.getElementById('google-login-btn');
      googleBtn.disabled = true;
      googleBtn.innerHTML = `
        <div class="spinner" style="width: 18px; height: 18px; border-width: 2px;"></div>
        Connecting...
      `;
      
      // Redirect to Google OAuth
      window.location.href = `${API_BASE}/auth/google`;
    }
    
    function loginWithGitHub() {
      const githubBtn = document.getElementById('github-login-btn');
      githubBtn.disabled = true;
      githubBtn.innerHTML = `
        <div class="spinner" style="width: 18px; height: 18px; border-width: 2px;"></div>
        Connecting...
      `;
      
      // Redirect to GitHub OAuth
      window.location.href = `${API_BASE}/auth/github`;
    }

    // Update login icon based on input type
    function updateLoginIcon() {
      const loginField = document.getElementById('loginField').value.trim();
      const loginIcon = document.getElementById('login-icon');
      
      if (loginField.includes('@')) {
        // Change to email icon
        loginIcon.innerHTML = `
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        `;
      } else {
        // Change to user icon
        loginIcon.innerHTML = `
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        `;
      }
    }

    // Initialize form enhancements
    function initializeFormEnhancements() {
      // Add keyboard navigation support
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
          const form = document.querySelector('.login-form');
          const inputs = form.querySelectorAll('input');
          const currentIndex = Array.from(inputs).indexOf(e.target);
          
          if (currentIndex < inputs.length - 1) {
            e.preventDefault();
            inputs[currentIndex + 1].focus();
          }
        }
      });

      // Add input validation on blur
      const loginFieldInput = document.getElementById('loginField');
      const passwordInput = document.getElementById('password');
      
      loginFieldInput.addEventListener('blur', function() {
        const loginField = this.value.trim();
        
        if (loginField && loginField.includes('@')) {
          // Validate email format
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(loginField)) {
            this.style.borderColor = 'hsl(0, 84%, 60%)';
            showMessage('Please enter a valid email address', 'error');
          } else {
            this.style.borderColor = '';
          }
        } else if (loginField && loginField.length < 3) {
          // Validate username length
          this.style.borderColor = 'hsl(0, 84%, 60%)';
          showMessage('Username must be at least 3 characters', 'error');
        } else {
          this.style.borderColor = '';
        }
      });
      
      passwordInput.addEventListener('blur', function() {
        if (this.value && this.value.length < 6) {
          this.style.borderColor = 'hsl(0, 84%, 60%)';
          showMessage('Password must be at least 6 characters', 'error');
        } else {
          this.style.borderColor = '';
        }
      });
    }

    // Handle form submission on Enter key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.closest('.login-form')) {
        const submitBtn = document.getElementById('login-btn');
        if (!submitBtn.disabled) {
          submitBtn.click();
        }
      }
    });
  </script>
</body>
</html>
